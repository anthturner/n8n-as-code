# Technical Specification: N8N Sync CLI

**Title:** N8N Sync Command Line Interface (CLI)  
**Version:** 2.0 (Final Draft)  
**Target Package:** n8n-sync-cli  
**Dependencies:** n8n-sync-core (v3), commander, inquirer, chalk, ora, cli-table3

## 1. Executive Summary

The CLI provides a terminal-based interface for the N8N Sync Core. It replicates the features of the VS Code extension for headless environments. It includes an interactive dashboard for monitoring (watch), a snapshot view (list), and utilities to maintain the AI coding context.

## 2. Command Reference

The CLI uses `commander` to define the following interface:
```bash
n8n-sync [command] [options]
```

### 2.1. init

**Description:** Interactive wizard to bootstrap the project.

**Flow:**

**Configuration Prompts:**
- N8N Host URL
- API Key (Masked)
- Sync Folder Path (Default: `./workflows`)

**Core Initialization:** Writes configuration to file.

**AI Bootstrap:** Automatically triggers the logic of `update-ai` (see below) to generate `AGENTS.md`, `n8n-schema.json`, and rule files immediately, ensuring the project is "AI-Ready" from the start.

### 2.2. list (Snapshot)

**Description:** Displays a static table of all workflows and their current sync status, then exits.

**Behavior:**
- Instantiates Core.
- Runs `Watcher.refresh()` (Force Poll + Scan).
- **Output:** Prints a formatted ASCII table (using `cli-table3`) with columns: Status, ID, Name, Local Path.

**Use Case:** Quick check of the state without blocking the terminal (useful for CI/CD or quick verification).

### 2.3. watch (Real-time Dashboard)

**Description:** Starts the Core Watcher in Passive Mode with a live UI.

**Behavior:**
- **Process:** Long-running process. Listens to file changes and polls API.
- **UI:** Clears the terminal console on every state change and re-renders the Status Table (similar to `list` but live).
- **Feedback:** Shows a spinner "Watching for changes..." at the bottom.
- **Action:** Does NOT auto-sync. It only reports status.

### 2.4. auto-sync (Bi-Directional)

**Description:** Starts the Core in Active Mode.

**Behavior:**
- Starts Watcher.
- **Logic:**
  - `MODIFIED_LOCALLY` -> Trigger Push.
  - `MODIFIED_REMOTLY` -> Trigger Pull.
  - `CONFLICT` -> Pause and trigger Interactive Prompt (see Section 3).
- **UI:** Instead of a table, it uses a Log Stream format to show history of actions:
```
[14:00:01] üü¢ PUSHED: "My Workflow" (ID: 123)
[14:05:22] üîµ PULLED: "Data Scraper" (ID: 456)
```

### 2.5. pull

**Description:** One-off command to download workflows from Remote to Local.

**Options:** `--force` (Skip conflict checks, overwrite local).

**Logic:**
- Refreshes Matrix.
- Filters for `EXIST_ONLY_REMOTLY` and `MODIFIED_REMOTLY`.
- **Conflict Safety:** If `CONFLICT` exists -> Trigger Interactive Resolution.
- Executes Pull & Commits State.

### 2.6. push

**Description:** One-off command to upload workflows from Local to Remote.

**Options:** `--force` (Skip conflict checks, overwrite remote).

**Logic:**
- Refreshes Matrix.
- Filters for `EXIST_ONLY_LOCALLY` and `MODIFIED_LOCALLY`.
- **Conflict Safety:** If `CONFLICT` exists -> Trigger Interactive Resolution.
- Executes Push & Commits State.

### 2.7. update-ai

**Description:** Maintenance command to refresh AI Context files.

**Use Case:** To be used when N8N updates (API changes) or when the internal agent-cli logic is updated.

**Behavior:**
- Checks for `agent-cli`.
- Regenerates `AGENTS.md` (Context & Instructions).
- Regenerates `n8n-schema.json` (Latest Node Types).
- Regenerates Rule Files (Project conventions).

**Note:** This does NOT change workflow files, only the documentation/helper files for the AI Agent.

### 2.8. help

Standard help generated by `commander`.

## 3. Interactive Resolution Flows (Inquirer)

The CLI uses `inquirer` to handle blocking states during `push`, `pull`, or `auto-sync`.

### 3.1. Conflict Resolution

**Trigger:** `CONFLICT` status detected.

**Prompt UI:**
```
‚ö†Ô∏è  CONFLICT DETECTED: "Workflow Name" (ID: xyz)
Both local and remote versions have changed since last sync.

? How do you want to resolve this?
> [1] Keep Local Version (Force Push)
  [2] Keep Remote Version (Force Pull)
  [3] Show Diff (Display colored diff)
  [4] Skip
```

**Diff Output:** Uses `diff` package to print a colored patch in the console (Green + / Red -) then re-displays the prompt.

### 3.2. Deletion Validation

**Trigger:** `DELETED_LOCALLY` or `DELETED_REMOTLY`.

**Prompt (Local Missing):**
```
? Local file missing for "Workflow X". Action:
> [1] Confirm Deletion (Delete on N8N)
  [2] Restore File (Download from N8N)
  [3] Skip
```

**Prompt (Remote Missing):**
```
? Remote workflow missing for "Workflow Y". Action:
> [1] Archive Local File (Move to _archive/)
  [2] Restore to Remote (Push Local content)
  [3] Skip
```

## 4. Visual Output Standards

To ensure consistency with VS Code, the CLI uses the same color coding logic (via `chalk`).

| Status | Color | Icon |
|--------|-------|------|
| IN_SYNC | Green | ‚úî |
| MODIFIED_LOCALLY | Blue | ‚úèÔ∏è |
| MODIFIED_REMOTLY | Cyan | ‚òÅÔ∏è |
| CONFLICT | Red | üí• |
| DELETED | Gray | üóëÔ∏è |

## 5. Implementation Notes

- **Dashboards:** For the `watch` command, consider using `log-update` (lighter) or `ink` (React-based CLI) to handle the "re-rendering" of the table without flickering, rather than a raw `console.clear()`.
- **Table Library:** Use `cli-table3` for robust Unicode border support.
- **Error Handling:** All commands must wrap the Core logic in try/catch blocks to print user-friendly error messages (e.g., "Connection Refused") instead of raw stack traces.